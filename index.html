<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SketchRevive</title>

  <!-- Fabric.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue",
        Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", sans-serif;
      background: radial-gradient(circle at top left, #3b82f6 0, #020617 50%, #020617 100%);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 1360px;
      margin: 24px;
      padding: 24px;
      border-radius: 24px;
      background: rgba(15, 23, 42, 0.92);
      box-shadow:
        0 24px 60px rgba(0, 0, 0, 0.6),
        0 0 0 1px rgba(148, 163, 184, 0.1);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      border-bottom: 1px dashed rgba(148, 163, 184, 0.4);
      padding-bottom: 10px;
    }

    header h1 {
      font-size: 24px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0;
      letter-spacing: 0.02em;
    }

    header h1 span.icon {
      display: inline-flex;
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #f97316, #e11d48);
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 10px 22px rgba(225, 29, 72, 0.25);
    }

    .boards {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      .boards { grid-template-columns: minmax(0, 1fr); }
    }

    .board {
      border-radius: 20px;
      background: radial-gradient(circle at top, rgba(30, 64, 175, 0.3), rgba(15, 23, 42, 0.96));
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      min-height: 520px;
    }

    .board-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .board-title {
      font-size: 15px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 0;
      position: relative;
      padding-left: 14px;
    }

    .board-title::before {
      content: "";
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 6px rgba(34, 197, 94, 0.9);
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      padding: 8px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .toolbar-group {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
    }

    .toolbar-group label {
      font-size: 11px;
      color: #9ca3af;
      white-space: nowrap;
    }

    .toolbar select,
    .toolbar input[type="color"],
    .toolbar input[type="range"],
    .toolbar button {
      font-size: 11px;
    }

    .toolbar select {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      padding: 4px 24px 4px 8px;
      appearance: none;
    }

    .toolbar input[type="color"] {
      width: 32px;
      height: 20px;
      padding: 0;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: transparent;
      cursor: pointer;
    }

    .toolbar input[type="range"] {
      width: 90px;
      accent-color: #60a5fa;
      cursor: pointer;
    }

    .toolbar button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      background: linear-gradient(90deg, #2563eb, #4f46e5);
      color: #e5e7eb;
      font-weight: 800;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
      transition: transform 0.08s ease, box-shadow 0.08s ease;
      white-space: nowrap;
    }

    .toolbar button.secondary { background: rgba(30, 64, 175, 0.5); }
    .toolbar button.danger { background: linear-gradient(90deg, #f97316, #e11d48); }

    .toolbar button:hover {
      transform: translateY(-0.5px);
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.9);
    }

    .canvas-wrapper {
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: #ffffff;
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.12);
      position: relative;
    }

    .canvas-wrapper canvas { display: block; background: transparent; }

    .canvas-footer {
      display: flex;
      justify-content: flex-end;
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    /* Voice panel */
    .voice-panel {
      margin-top: 8px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: radial-gradient(circle at top, rgba(30, 64, 175, 0.4), rgba(15, 23, 42, 0.96));
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .voice-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      font-weight: 800;
    }

    .voice-status {
      font-size: 11px;
      color: #9ca3af;
    }

    .voice-status.active { color: #22c55e; }

    .voice-textarea {
      width: 100%;
      min-height: 90px;
      resize: vertical;
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      font-size: 11px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
    }

    .voice-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .voice-hint { font-size: 11px; color: #9ca3af; }

    .voice-button {
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: radial-gradient(circle at 0% 0%, #f97316, #e11d48);
      color: #e5e7eb;
      font-size: 12px;
      font-weight: 900;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.85),
        0 10px 24px rgba(248, 113, 113, 0.5);
    }

    .voice-button.listening {
      background: radial-gradient(circle at 0% 0%, #ef4444, #b91c1c);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.85),
        0 12px 30px rgba(239, 68, 68, 0.7);
    }

    .pill-icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 900;
    }

    /* Right: results */
    .right-layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 280px; /* main + sidebar */
      gap: 10px;
      min-height: 440px;
    }

    @media (max-width: 980px) {
      .right-layout { grid-template-columns: 1fr; }
    }

    .result-main {
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.65);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 360px;
    }

    .big-img-wrap {
      flex: 1;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(255, 255, 255, 0.04);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 280px;
      position: relative;
    }

    .big-img-wrap img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      background: rgba(0, 0, 0, 0.15);
    }

    .badge {
      position: absolute;
      left: 10px;
      top: 10px;
      font-size: 11px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(2, 6, 23, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.25);
      color: #e5e7eb;
      backdrop-filter: blur(6px);
    }

    .meta {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 12px;
      color: #cbd5e1;
    }

    .meta .tag { font-size: 11px; color: #9ca3af; }

    .sidebar {
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.65);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: auto;
    }

    .sidebar-title {
      font-size: 12px;
      color: #cbd5e1;
      font-weight: 900;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .thumbs {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
    }

    .thumb {
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(255, 255, 255, 0.04);
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease;
    }

    .thumb:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(0, 0, 0, 0.25);
    }

    .thumb img {
      width: 100%;
      height: 52px;
      object-fit: cover;
      display: block;
    }

    .thumb.active {
      outline: 2px solid rgba(34, 197, 94, 0.9);
      outline-offset: 1px;
    }

    .empty {
      font-size: 12px;
      color: #94a3b8;
      border: 1px dashed rgba(148, 163, 184, 0.3);
      border-radius: 14px;
      padding: 12px;
      text-align: center;
      background: rgba(2, 6, 23, 0.25);
      width: 100%;
    }

    .completion-btn {
      margin-left: auto;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: radial-gradient(circle at 0% 0%, #22c55e, #16a34a);
      color: #e5e7eb;
      font-size: 12px;
      font-weight: 1000;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.85),
        0 12px 30px rgba(22, 163, 74, 0.45);
      transition: transform 0.1s ease, box-shadow 0.1s ease;
      white-space: nowrap;
    }

    .completion-btn:hover {
      transform: translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.85),
        0 18px 40px rgba(22, 163, 74, 0.6);
    }

    .hint-inline { font-size: 11px; color: #9ca3af; }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <h1><span class="icon">‚úèÔ∏è</span>SketchRevive</h1>
    </header>

    <main class="boards">

      <!-- LEFT BOARD (unchanged: whiteboard + voice text input) -->
      <section class="board">
        <div class="board-header">
          <div class="board-title">Sketch Board</div>
        </div>

        <div class="toolbar">
          <div class="toolbar-group">
            <label for="left-drawing-mode-selector">Brush</label>
            <select id="left-drawing-mode-selector">
              <option value="Pencil">Pencil</option>
              <option value="Circle">Circle</option>
              <option value="Spray">Spray</option>
              <option value="hline">Horizontal Pattern</option>
              <option value="vline">Vertical Pattern</option>
              <option value="square">Square Pattern</option>
              <option value="diamond">Diamond Pattern</option>
            </select>
          </div>

          <div class="toolbar-group">
            <label>Stroke</label>
            <input type="color" id="left-drawing-color" value="#000000" />
          </div>

          <div class="toolbar-group">
            <label>Shadow</label>
            <input type="color" id="left-drawing-shadow-color" value="#000000" />
          </div>

          <div class="toolbar-group">
            <label>Width <span id="left-line-width-label">10</span></label>
            <input type="range" id="left-drawing-line-width" min="1" max="60" value="10" />
          </div>

          <div class="toolbar-group">
            <label>Blur <span id="left-shadow-width-label">0</span></label>
            <input type="range" id="left-drawing-shadow-width" min="0" max="40" value="0" />
          </div>

          <div class="toolbar-group">
            <label>Offset <span id="left-shadow-offset-label">0</span></label>
            <input type="range" id="left-drawing-shadow-offset" min="0" max="40" value="0" />
          </div>

          <button id="left-drawing-mode">
            <span>üé®</span>
            <span>Exit Drawing Mode</span>
          </button>

          <button id="left-delete-object" class="secondary">
            <span>üóëÔ∏è</span>
            <span>Delete Selected</span>
          </button>

          <button id="left-clear-canvas" class="danger">
            <span>üßπ</span>
            <span>Clear Canvas</span>
          </button>
        </div>

        <div class="canvas-wrapper">
          <canvas id="left-canvas" width="600" height="360"></canvas>
        </div>

        <div class="canvas-footer">
          <span>Tip: Select a stroke to recolor it using the Stroke picker.</span>
        </div>

        <!-- Voice Input Component (LEFT) -->
        <div class="voice-panel">
          <div class="voice-header">
            <span>Voice Input</span>
            <span id="left-voice-status" class="voice-status">Idle</span>
          </div>

          <textarea
            id="left-voice-text"
            class="voice-textarea"
            placeholder="Speech-to-text transcript will appear here..."
          ></textarea>

          <div class="voice-row">
            <span class="voice-hint">
              Click to start/stop voice recognition (requires SpeechRecognition support).
            </span>

            <button id="left-voice-btn" class="voice-button">
              <span class="pill-icon">üé§</span>
              <span>Start Voice</span>
            </button>
          </div>
        </div>
      </section>

      <!-- RIGHT BOARD (results only, no drawing) -->
      <section class="board">
        <div class="board-header">
          <div class="board-title">Image Retrieval</div>
        </div>

        <div class="toolbar">
          <span class="hint-inline">No API. Click Completion to show preset Top5 (replaces previous results).</span>
          <button id="right-completion-btn" class="completion-btn">
            <span class="pill-icon">‚úì</span>
            <span>Completion</span>
          </button>
        </div>

        <div class="right-layout">
          <!-- Big image -->
          <div class="result-main">
            <div class="big-img-wrap">
              <div class="empty" id="bigEmpty">
                No results yet. Click <b>Completion</b> to show preset Top5.
              </div>
              <img id="bigImg" alt="" style="display:none;" />
              <div class="badge" id="bigBadge" style="display:none;"></div>
            </div>

            <div class="meta">
              <div>
                <div id="bigTitle" style="font-weight:900;">‚Äî</div>
                <div class="tag" id="bigSub">‚Äî</div>
              </div>
              <div class="tag">Click thumbnails to switch</div>
            </div>
          </div>

          <!-- Sidebar: current Top5 only -->
          <aside class="sidebar">
            <div class="sidebar-title">
              <span>Top5</span>
              <span class="hint-inline" id="roundLabel">Round 0/3</span>
            </div>

            <div id="thumbsWrap">
              <div class="empty">No Top5 yet.</div>
            </div>
          </aside>
        </div>
      </section>

    </main>
  </div>

  <script>
    // ---------- PatternBrush helper ----------
    function createPatternBrush(canvas, mode) {
      const PatternBrush = fabric.PatternBrush;
      if (!PatternBrush) return new fabric.PencilBrush(canvas);

      const brush = new PatternBrush(canvas);

      if (mode === "hline") {
        brush.getPatternSrc = function () {
          const patternCanvas = fabric.util.createCanvasElement();
          patternCanvas.width = patternCanvas.height = 10;
          const ctx = patternCanvas.getContext("2d");
          ctx.strokeStyle = this.color;
          ctx.lineWidth = 5;
          ctx.beginPath();
          ctx.moveTo(0, 5);
          ctx.lineTo(10, 5);
          ctx.stroke();
          return patternCanvas;
        };
      } else if (mode === "vline") {
        brush.getPatternSrc = function () {
          const patternCanvas = fabric.util.createCanvasElement();
          patternCanvas.width = patternCanvas.height = 10;
          const ctx = patternCanvas.getContext("2d");
          ctx.strokeStyle = this.color;
          ctx.lineWidth = 5;
          ctx.beginPath();
          ctx.moveTo(5, 0);
          ctx.lineTo(5, 10);
          ctx.stroke();
          return patternCanvas;
        };
      } else if (mode === "square") {
        brush.getPatternSrc = function () {
          const squareWidth = 10, squareDistance = 2;
          const patternCanvas = fabric.util.createCanvasElement();
          patternCanvas.width = patternCanvas.height = squareWidth + squareDistance;
          const ctx = patternCanvas.getContext("2d");
          ctx.fillStyle = this.color;
          ctx.fillRect(0, 0, squareWidth, squareWidth);
          return patternCanvas;
        };
      } else if (mode === "diamond") {
        brush.getPatternSrc = function () {
          const squareWidth = 10, squareDistance = 5;
          const patternCanvas = fabric.util.createCanvasElement();
          const rect = new fabric.Rect({
            width: squareWidth,
            height: squareWidth,
            angle: 45,
            fill: this.color,
          });
          const canvasWidth = rect.getBoundingRect().width;
          patternCanvas.width = patternCanvas.height = canvasWidth + squareDistance;
          rect.set({ left: canvasWidth / 2, top: canvasWidth / 2 });
          rect.render(patternCanvas.getContext("2d"));
          return patternCanvas;
        };
      }

      return brush;
    }

    // ---------- Left board init ----------
    function initLeftBoard(prefix, canvasId) {
      const canvas = new fabric.Canvas(canvasId);
      canvas.isDrawingMode = true;

      // White background by default
      canvas.setBackgroundColor("#ffffff", canvas.renderAll.bind(canvas));

      const modeSelector = document.getElementById(prefix + "-drawing-mode-selector");
      const colorInput = document.getElementById(prefix + "-drawing-color");
      const shadowColorInput = document.getElementById(prefix + "-drawing-shadow-color");
      const lineWidthInput = document.getElementById(prefix + "-drawing-line-width");
      const shadowWidthInput = document.getElementById(prefix + "-drawing-shadow-width");
      const shadowOffsetInput = document.getElementById(prefix + "-drawing-shadow-offset");

      const clearBtn = document.getElementById(prefix + "-clear-canvas");
      const delBtn = document.getElementById(prefix + "-delete-object");
      const modeBtn = document.getElementById(prefix + "-drawing-mode");

      const lineWidthLabel = document.getElementById(prefix + "-line-width-label");
      const shadowWidthLabel = document.getElementById(prefix + "-shadow-width-label");
      const shadowOffsetLabel = document.getElementById(prefix + "-shadow-offset-label");

      const modeBtnText = modeBtn.querySelector("span:last-child");

      function applyBrushOptions() {
        const brush = canvas.freeDrawingBrush;
        if (!brush) return;

        // default stroke black
        brush.color = colorInput.value || "#000000";
        brush.width = parseInt(lineWidthInput.value, 10) || 1;

        const blur = parseInt(shadowWidthInput.value, 10) || 0;
        const offset = parseInt(shadowOffsetInput.value, 10) || 0;

        if (blur > 0 || offset !== 0) {
          brush.shadow = new fabric.Shadow({
            blur,
            offsetX: offset,
            offsetY: offset,
            color: shadowColorInput.value || "#000000",
            affectStroke: true,
          });
        } else {
          brush.shadow = null;
        }
      }

      function setBrush(mode) {
        if (mode === "hline" || mode === "vline" || mode === "square" || mode === "diamond") {
          canvas.freeDrawingBrush = createPatternBrush(canvas, mode);
        } else {
          const brushClass = fabric[mode + "Brush"];
          canvas.freeDrawingBrush = brushClass ? new brushClass(canvas) : new fabric.PencilBrush(canvas);
        }
        applyBrushOptions();
      }

      setBrush(modeSelector.value);

      modeBtn.addEventListener("click", () => {
        canvas.isDrawingMode = !canvas.isDrawingMode;
        modeBtnText.textContent = canvas.isDrawingMode ? "Exit Drawing Mode" : "Enter Drawing Mode";
      });

      modeSelector.addEventListener("change", () => setBrush(modeSelector.value));

      // Color affects brush + selected objects (stroke)
      colorInput.addEventListener("change", () => {
        applyBrushOptions();

        const color = colorInput.value || "#000000";
        const activeObjects = canvas.getActiveObjects();
        if (activeObjects && activeObjects.length > 0) {
          activeObjects.forEach((obj) => {
            if ("stroke" in obj && obj.stroke != null) obj.set("stroke", color);
          });
          canvas.requestRenderAll();
        }
      });

      shadowColorInput.addEventListener("change", applyBrushOptions);

      lineWidthInput.addEventListener("change", () => {
        const v = parseInt(lineWidthInput.value, 10) || 1;
        if (lineWidthLabel) lineWidthLabel.textContent = v;
        applyBrushOptions();
      });

      shadowWidthInput.addEventListener("change", () => {
        const v = parseInt(shadowWidthInput.value, 10) || 0;
        if (shadowWidthLabel) shadowWidthLabel.textContent = v;
        applyBrushOptions();
      });

      shadowOffsetInput.addEventListener("change", () => {
        const v = parseInt(shadowOffsetInput.value, 10) || 0;
        if (shadowOffsetLabel) shadowOffsetLabel.textContent = v;
        applyBrushOptions();
      });

      clearBtn.addEventListener("click", () => {
        canvas.clear();
        canvas.setBackgroundColor("#ffffff", canvas.renderAll.bind(canvas));
      });

      delBtn.addEventListener("click", () => {
        const activeObjects = canvas.getActiveObjects();
        if (!activeObjects || activeObjects.length === 0) return;

        activeObjects.forEach((obj) => canvas.remove(obj));
        canvas.discardActiveObject();
        canvas.requestRenderAll();
      });

      return canvas;
    }

    // ---------- Right board preset results (replace each time) ----------
    const PRESET_GROUPS = [
      {
        name: "Round 1/3",
        top5: [
          { id: "g1-1", title: "Top1 - Group1", url: "https://picsum.photos/seed/sketchrevive-g1-1/1200/800", thumb: "https://picsum.photos/seed/sketchrevive-g1-1/320/200" },
          { id: "g1-2", title: "Top2 - Group1", url: "https://picsum.photos/seed/sketchrevive-g1-2/1200/800", thumb: "https://picsum.photos/seed/sketchrevive-g1-2/320/200" },
          { id: "g1-3", title: "Top3 - Group1", url: "https://picsum.photos/seed/sketchrevive-g1-3/1200/800", thumb: "https://picsum.photos/seed/sketchrevive-g1-3/320/200" },
          { id: "g1-4", title: "Top4 - Group1", url: "https://picsum.photos/seed/sketchrevive-g1-4/1200/800", thumb: "https://picsum.photos/seed/sketchrevive-g1-4/320/200" },
          { id: "g1-5", title: "Top5 - Group1", url: "https://picsum.photos/seed/sketchrevive-g1-5/1200/800", thumb: "https://picsum.photos/seed/sketchrevive-g1-5/320/200" },
        ]
      },
      {
        name: "Round 2/3",
        top5: [
          { id: "g2-1", title: "Top1 - Group2", url: "https://picsum.photos/seed/sketchrevive-g2-1/1200/800", thumb: "https://picsum.photos/seed/sketchrevive-g2-1/320/200" },
          { id: "g2-2", title: "Top2 - Group2", url: "https://picsum.photos/seed/sketchrevive-g2-2/1200/800", thumb: "https://picsum.photos/seed/sketchrevive-g2-2/320/200" },
          { id: "g2-3", title: "Top3 - Group2", url: "https://picsum.photos/seed/sketchrevive-g2-3/1200/800", thumb: "https://picsum.photos/seed/sketchrevive-g2-3/320/200" },
          { id: "g2-4", title: "Top4 - Group2", url: "https://picsum.photos/seed/sketchrevive-g2-4/1200/800", thumb: "https://picsum.photos/seed/sketchrevive-g2-4/320/200" },
          { id: "g2-5", title: "Top5 - Group2", url: "https://picsum.photos/seed/sketchrevive-g2-5/1200/800", thumb: "https://picsum.photos/seed/sketchrevive-g2-5/320/200" },
        ]
      },
      {
        name: "Round 3/3",
        top5: [
          { id: "g3-1", title: "Top1 - Group3", url: "https://picsum.photos/seed/sketchrevive-g3-1/1200/800", thumb: "https://picsum.photos/seed/sketchrevive-g3-1/320/200" },
          { id: "g3-2", title: "Top2 - Group3", url: "https://picsum.photos/seed/sketchrevive-g3-2/1200/800", thumb: "https://picsum.photos/seed/sketchrevive-g3-2/320/200" },
          { id: "g3-3", title: "Top3 - Group3", url: "https://picsum.photos/seed/sketchrevive-g3-3/1200/800", thumb: "https://picsum.photos/seed/sketchrevive-g3-3/320/200" },
          { id: "g3-4", title: "Top4 - Group3", url: "https://picsum.photos/seed/sketchrevive-g3-4/1200/800", thumb: "https://picsum.photos/seed/sketchrevive-g3-4/320/200" },
          { id: "g3-5", title: "Top5 - Group3", url: "https://picsum.photos/seed/sketchrevive-g3-5/1200/800", thumb: "https://picsum.photos/seed/sketchrevive-g3-5/320/200" },
        ]
      }
    ];

    let roundIndex = -1; // next click -> 0
    let currentTop5 = [];
    let selectedId = null;

    function setBigImage(item, roundName, rankText) {
      const bigEmpty = document.getElementById("bigEmpty");
      const bigImg = document.getElementById("bigImg");
      const bigBadge = document.getElementById("bigBadge");
      const bigTitle = document.getElementById("bigTitle");
      const bigSub = document.getElementById("bigSub");

      bigEmpty.style.display = "none";
      bigImg.style.display = "block";
      bigBadge.style.display = "block";

      bigImg.src = item.url;
      bigImg.alt = item.title;

      bigTitle.textContent = item.title;
      bigSub.textContent = `${roundName} ¬∑ ${rankText}`;
      bigBadge.textContent = `${roundName} ¬∑ ${rankText}`;
    }

    function renderTop5() {
      const thumbsWrap = document.getElementById("thumbsWrap");
      thumbsWrap.innerHTML = "";

      if (!currentTop5 || currentTop5.length === 0) {
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.textContent = "No Top5 yet.";
        thumbsWrap.appendChild(empty);
        return;
      }

      const grid = document.createElement("div");
      grid.className = "thumbs";

      currentTop5.forEach((it) => {
        const div = document.createElement("div");
        div.className = "thumb" + (selectedId === it.id ? " active" : "");
        div.title = it.title;

        const img = document.createElement("img");
        img.src = it.thumb;
        img.alt = it.title;

        div.appendChild(img);

        div.addEventListener("click", () => {
          selectedId = it.id;
          const roundName = PRESET_GROUPS[roundIndex].name;
          setBigImage(it, roundName, "Selected");
          renderTop5(); // refresh active outline
        });

        grid.appendChild(div);
      });

      thumbsWrap.appendChild(grid);
    }

    function applyRound() {
      const group = PRESET_GROUPS[roundIndex];
      currentTop5 = group.top5.slice(0, 5);

      // Top1 enlarged by default
      const top1 = currentTop5[0];
      selectedId = top1.id;

      document.getElementById("roundLabel").textContent = group.name;

      setBigImage(top1, group.name, "Top1 enlarged");
      renderTop5();
    }

    // ---------- Voice input ----------
    function initVoice() {
      const voiceBtn = document.getElementById("left-voice-btn");
      const voiceText = document.getElementById("left-voice-text");
      const voiceStatus = document.getElementById("left-voice-status");

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      if (!SpeechRecognition) {
        voiceStatus.textContent = "Not supported in this browser";
        voiceBtn.disabled = true;
        voiceBtn.style.opacity = 0.5;
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = "en-US";
      recognition.continuous = true;
      recognition.interimResults = true;

      let listening = false;
      let finalText = "";

      recognition.onstart = () => {
        voiceStatus.textContent = "Listening...";
        voiceStatus.classList.add("active");
        voiceBtn.classList.add("listening");
        voiceBtn.querySelector("span:last-child").textContent = "Stop Voice";
      };

      recognition.onend = () => {
        voiceStatus.textContent = "Idle";
        voiceStatus.classList.remove("active");
        voiceBtn.classList.remove("listening");
        voiceBtn.querySelector("span:last-child").textContent = "Start Voice";
        listening = false;
      };

      recognition.onerror = (event) => {
        console.error("Speech recognition error:", event);
        voiceStatus.textContent = "Error";
        listening = false;
        voiceBtn.classList.remove("listening");
        voiceBtn.querySelector("span:last-child").textContent = "Start Voice";
      };

      recognition.onresult = (event) => {
        let interim = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) finalText += transcript + " ";
          else interim += transcript;
        }
        voiceText.value = finalText + interim;
      };

      voiceBtn.addEventListener("click", (e) => {
        e.preventDefault();
        if (!listening) {
          finalText = voiceText.value || "";
          listening = true;
          try { recognition.start(); } catch (err) { console.warn("Recognition start error:", err); }
        } else {
          listening = false;
          try { recognition.stop(); } catch (err) { console.warn("Recognition stop error:", err); }
        }
      });
    }

    // ---------- Boot ----------
    window.addEventListener("DOMContentLoaded", () => {
      initLeftBoard("left", "left-canvas");
      initVoice();

      const completionBtn = document.getElementById("right-completion-btn");
      completionBtn.addEventListener("click", () => {
        // next round (replace previous results)
        roundIndex = (roundIndex + 1) % PRESET_GROUPS.length;
        applyRound();
      });
    });
  </script>
</body>
</html>
